<div class="h-100">
    <div class="d-flex flex-column h-100">
        <h5 class="mat-body-2 text-secondary fw-bold mb-3">Select Block</h5>
        <div>
            <mat-form-field appearance="outline" class="w-50">
                <mat-label>Select Block</mat-label>
                <mat-select [formControl]="roleForm.get('feature_id')">
                    <mat-option *ngFor="let feature of features" [value]="feature.reference_id">
                        {{ feature.name }}
                    </mat-option>
                </mat-select>
                <mat-error *ngIf="roleForm.get('feature_id')?.hasError('required')"> Block is required </mat-error>
            </mat-form-field>
        </div>

        <div *ngIf="roleForm.get('feature_id')?.value" class="mt-2">
            <h5 class="mat-body-2 text-secondary fw-bold">Create Roles & Permissions</h5>

            <mat-tab-group>
                <mat-tab label="Roles">
                    <div class="mt-4">
                        <div class="d-flex justify-content-between roles-table">
                            <div class="d-flex flex-wrap align-items-center flex-grow-1 gap-3 mb-3">
                                <proxy-lib-search
                                    [matFormFieldClass]="'no-padding w-xs-100'"
                                    [placeholder]="'Search Roles'"
                                    (inputChanges)="search($event)"
                                    class="w-xs-100"
                                ></proxy-lib-search>
                            </div>
                            <button class="mb-4" mat-flat-button color="primary" (click)="addRole()">Add Role</button>
                        </div>
                        <table
                            mat-table
                            [dataSource]="rolesDataSource"
                            class="default-table responsive-table roles-table table-border"
                        >
                            <!-- Roles Column -->
                            <ng-container matColumnDef="role">
                                <th mat-header-cell *matHeaderCellDef>Roles</th>
                                <td mat-cell *matCellDef="let element" data-label="Roles">
                                    <div class="d-flex align-items-center justify-content-between">
                                        <span class="role-name">{{ element.role }}</span>
                                    </div>
                                </td>
                            </ng-container>

                            <!-- Permissions Column -->
                            <ng-container matColumnDef="permissions">
                                <th mat-header-cell *matHeaderCellDef>Permissions</th>
                                <td mat-cell *matCellDef="let element" data-label="Permissions">
                                    <ul class="permissions-list mb-0">
                                        <li *ngFor="let permission of element.permissionsList">
                                            {{ permission.name }}
                                        </li>
                                    </ul>
                                </td>
                            </ng-container>

                            <!-- Actions Column -->
                            <ng-container matColumnDef="actions">
                                <th mat-header-cell *matHeaderCellDef></th>
                                <td mat-cell *matCellDef="let element" data-label="Actions">
                                    <div class="actions">
                                        <span
                                            [matTooltip]="
                                                !element.feature_configuration_id ? 'Default Role is not editable' : ''
                                            "
                                            matTooltipPosition="above"
                                        >
                                            <button
                                                mat-stroked-button
                                                color="primary"
                                                (click)="editRole(element)"
                                                class="mat-btn-md"
                                                [disabled]="!element.feature_configuration_id"
                                            >
                                                <mat-icon class="material-icons-outlined mat-icon-18 mat-icon-prefix"
                                                    >edit</mat-icon
                                                >
                                                Edit
                                            </button>
                                        </span>
                                        <span
                                            [matTooltip]="
                                                !element.feature_configuration_id
                                                    ? 'Default role are not deletable'
                                                    : ''
                                            "
                                            matTooltipPosition="above"
                                        >
                                            <button
                                                mat-stroked-button
                                                color="primary"
                                                (click)="deleteRole(element)"
                                                class="mat-btn-md"
                                                [disabled]="!element.feature_configuration_id"
                                            >
                                                <mat-icon class="material-icons-outlined mat-icon-18 mat-icon-prefix"
                                                    >delete</mat-icon
                                                >
                                                Delete
                                            </button>
                                        </span>
                                    </div>
                                </td>
                            </ng-container>

                            <tr mat-header-row *matHeaderRowDef="rolesDisplayedColumns; sticky: true"></tr>
                            <tr mat-row *matRowDef="let row; columns: rolesDisplayedColumns" class="hover-action"></tr>

                            <tr *matNoDataRow>
                                <td class="mat-cell border-none" [attr.colspan]="rolesDisplayedColumns.length">
                                    <div class="text-center w-100 mat-subtitle-2 text-dark">No Record Found</div>
                                </td>
                            </tr>
                        </table>
                        <mat-paginator
                            #rolesPaginator
                            [pageSizeOptions]="pageSizeOptions"
                            [pageSize]="rolesPageSize"
                            showFirstLastButtons
                            aria-label="Select page of roles"
                            (page)="onRolesPageChange($event)"
                            class="roles-table"
                        >
                        </mat-paginator>
                    </div>
                </mat-tab>

                <mat-tab label="Permissions">
                    <div class="mt-4">
                        <div class="d-flex justify-content-between roles-table">
                            <div class="d-flex flex-wrap align-items-center flex-grow-1 gap-3 mb-3">
                                <proxy-lib-search
                                    [matFormFieldClass]="'no-padding w-xs-100'"
                                    [placeholder]="'Search Permissions'"
                                    (inputChanges)="searchPermission($event)"
                                    class="w-xs-100"
                                ></proxy-lib-search>
                            </div>
                            <button class="mb-4" mat-flat-button color="primary" (click)="addPermission()">
                                Add Permission
                            </button>
                        </div>
                        <table
                            mat-table
                            [dataSource]="permissionsDataSource"
                            class="default-table responsive-table roles-table table-border"
                        >
                            <!-- Permission Column -->
                            <ng-container matColumnDef="permission">
                                <th mat-header-cell *matHeaderCellDef>Permissions</th>
                                <td mat-cell *matCellDef="let element" data-label="Permissions">
                                    <span class="role-name">{{ element.name }}</span>
                                </td>
                            </ng-container>

                            <!-- Actions Column -->
                            <ng-container matColumnDef="actions">
                                <th mat-header-cell *matHeaderCellDef></th>
                                <td mat-cell *matCellDef="let element" data-label="Actions">
                                    <div class="actions">
                                        <button
                                            mat-stroked-button
                                            color="primary"
                                            (click)="editPermission(element)"
                                            class="mat-btn-md"
                                            [disabled]="element.is_default"
                                        >
                                            <mat-icon class="material-icons-outlined mat-icon-18 mat-icon-prefix"
                                                >edit</mat-icon
                                            >
                                            Edit
                                        </button>
                                        <button
                                            mat-stroked-button
                                            color="primary"
                                            (click)="deletePermission(element)"
                                            class="mat-btn-md"
                                            [disabled]="element.is_default"
                                        >
                                            <mat-icon class="material-icons-outlined mat-icon-18 mat-icon-prefix"
                                                >delete</mat-icon
                                            >
                                            Delete
                                        </button>
                                    </div>
                                </td>
                            </ng-container>

                            <tr mat-header-row *matHeaderRowDef="permissionsDisplayedColumns; sticky: true"></tr>
                            <tr
                                mat-row
                                *matRowDef="let row; columns: permissionsDisplayedColumns"
                                class="hover-action"
                            ></tr>

                            <tr *matNoDataRow>
                                <td class="mat-cell border-none" [attr.colspan]="permissionsDisplayedColumns.length">
                                    <div class="text-center w-100 mat-subtitle-2 text-dark">No Record Found</div>
                                </td>
                            </tr>
                        </table>
                        <mat-paginator
                            #permissionsPaginator
                            [pageSizeOptions]="pageSizeOptions"
                            [pageSize]="permissionsPageSize"
                            showFirstLastButtons
                            aria-label="Select page of permissions"
                            (page)="onPermissionsPageChange($event)"
                            class="roles-table"
                        >
                        </mat-paginator>
                    </div>
                </mat-tab>
                <mat-tab label="Settings">
                    <div class="">
                        <p class="mat-body-2 text-secondary fw-bold p-0">Default Roles</p>

                        <form [formGroup]="defaultRolesForm" class="d-flex flex-column">
                            <!-- Default role for creator -->
                            <div class="">
                                <p class="mat-body-2 fw-bold">Default role for creator</p>
                                <p class="text-grey mb-3">
                                    The role that users are assigned after creating an organization.
                                </p>
                                <mat-form-field appearance="outline" class="w-50">
                                    <mat-label>Select default role for creator</mat-label>
                                    <mat-select formControlName="defaultRoleForCreator">
                                        <mat-option *ngFor="let role of rolesDataSource.data" [value]="role.id">
                                            {{ role.role }}
                                        </mat-option>
                                    </mat-select>
                                </mat-form-field>
                            </div>

                            <!-- Default role for member -->
                            <div>
                                <p class="mat-body-2 fw-bold">Default role for member</p>
                                <p class="text-grey">The role that users are assigned as a new organization member.</p>
                                <mat-form-field appearance="outline" class="w-50">
                                    <mat-label>Select default role for member</mat-label>
                                    <mat-select formControlName="defaultRoleForMember">
                                        <mat-option *ngFor="let role of rolesDataSource.data" [value]="role.id">
                                            {{ role.role }}
                                        </mat-option>
                                    </mat-select>
                                </mat-form-field>
                            </div>

                            <!-- Action Buttons -->
                            <div class="d-flex gap-2 mt-3">
                                <button
                                    mat-flat-button
                                    color="primary"
                                    (click)="saveDefaultRoles()"
                                    [disabled]="!defaultRolesForm.valid"
                                >
                                    Save
                                </button>
                                <button mat-button (click)="cancelDefaultRoles()">Cancel</button>
                            </div>
                        </form>
                    </div>
                </mat-tab>
            </mat-tab-group>
        </div>
    </div>
</div>

<!-- Add Role Dialog Template -->
<ng-template #addRoleDialogTemplate>
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 mat-dialog-title class="m-0">{{ isEditMode ? 'Edit Role' : 'Add Role' }}</h2>
        <button mat-icon-button mat-dialog-close>
            <mat-icon>close</mat-icon>
        </button>
    </div>
    <mat-dialog-content>
        <form [formGroup]="dialogRoleForm" class="d-flex flex-column">
            <mat-form-field appearance="outline" class="w-100 mb-3">
                <mat-label>Role Name <span class="text-danger">*</span></mat-label>
                <input matInput formControlName="roleName" placeholder="Enter role name" />
                <mat-error *ngIf="dialogRoleForm.get('roleName')?.hasError('required')">
                    Role name is required
                </mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline" class="w-100 mb-3">
                <mat-label>Permissions</mat-label>
                <mat-select formControlName="permissions" multiple>
                    <mat-option *ngFor="let permission of availablePermissions" [value]="permission.name">
                        {{ permission.name }}
                    </mat-option>
                </mat-select>
                <mat-hint>Select one or more permissions</mat-hint>
            </mat-form-field>

            <mat-form-field appearance="outline" class="w-100 mb-3">
                <mat-label>Description</mat-label>
                <textarea matInput formControlName="description" placeholder="Enter description" rows="3"></textarea>
            </mat-form-field>

            <div class="d-flex align-items-center gap-2 mb-3">
                <span class="me-2">Set this role to default role :</span>
                <mat-slide-toggle formControlName="is_default" color="primary"></mat-slide-toggle>
            </div>
        </form>
    </mat-dialog-content>
    <mat-dialog-actions align="end" class="mt-3">
        <button mat-button (click)="closeDialog()">Cancel</button>
        <button mat-flat-button color="primary" (click)="submitDialog()" [disabled]="!dialogRoleForm.valid">
            {{ isEditMode ? 'Update Role' : 'Add Role' }}
        </button>
    </mat-dialog-actions>
</ng-template>

<!-- Add Permission Dialog Template -->
<ng-template #addPermissionDialogTemplate>
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 mat-dialog-title class="m-0">{{ isEditPermissionMode ? 'Edit Permission' : 'Add Permission' }}</h2>
        <button mat-icon-button mat-dialog-close>
            <mat-icon>close</mat-icon>
        </button>
    </div>
    <mat-dialog-content>
        <form [formGroup]="dialogPermissionForm" class="d-flex flex-column">
            <mat-form-field appearance="outline" class="w-100 mb-3">
                <mat-label>Permission Name <span class="text-danger">*</span></mat-label>
                <input matInput formControlName="permissionName" placeholder="Enter permission name" />
                <mat-error *ngIf="dialogPermissionForm.get('permissionName')?.hasError('required')">
                    Permission name is required
                </mat-error>
            </mat-form-field>
        </form>
    </mat-dialog-content>
    <mat-dialog-actions align="end" class="mt-3">
        <button mat-button (click)="closePermissionDialog()">Cancel</button>
        <button
            mat-flat-button
            color="primary"
            (click)="submitPermissionDialog()"
            [disabled]="!dialogPermissionForm.valid"
        >
            {{ isEditPermissionMode ? 'Update Permission' : 'Add Permission' }}
        </button>
    </mat-dialog-actions>
</ng-template>
