<div class="app-content d-flex flex-column">
    <proxy-loader *ngIf="(isLoading$ | async) || (loadingScript | async)"></proxy-loader>
    <div
        class="d-flex justify-content-start gap-1 mb-3"
        [ngClass]="isEditMode ? 'align-items-start' : 'align-items-center'"
    >
        <button type="button" mat-icon-button color="primary" [routerLink]="['/app', 'features']">
            <mat-icon class="mat-icon-16">arrow_back_ios_new</mat-icon>
        </button>
        <ng-container *ngIf="isEditMode">
            <div class="d-flex align-items-center gap-1">
                <div *ngIf="nameFieldEditMode" class="d-flex align-items-start gap-1">
                    <ng-container
                        *ngTemplateOutlet="
                            inputField;
                            context: {
                                fieldControl: featureForm.get('primaryDetails.name'),
                                fieldConfig: {
                                    label: 'Name',
                                    is_required: true,
                                    patternErrorText: 'Name must contain only alphanumeric and underscore'
                                }
                            }
                        "
                    ></ng-container>
                    <button type="button" mat-icon-button color="success" (click)="updateFeature('name')" class="mt-1">
                        <mat-icon class="material-icons-outlined mat-icon-18"> done </mat-icon>
                    </button>
                </div>
                <ng-container *ngIf="!nameFieldEditMode">
                    <h4 class="my-0 text-secondary mat-body-1 fw-bold">{{ (featureDetails$ | async)?.name }}</h4>
                    <button type="button" mat-icon-button color="primary" (click)="nameFieldEditMode = true">
                        <mat-icon class="material-icons-outlined mat-icon-18"> edit </mat-icon>
                    </button>
                </ng-container>
            </div>
        </ng-container>
        <ng-container *ngIf="!isEditMode">
            <h4 class="my-0 text-secondary mat-body-1 fw-bold">Add New Blocks</h4>
        </ng-container>
    </div>
    <mat-stepper
        #stepper
        class="rounded-8 border flex-grow-1 mat-stepper-starched"
        labelPosition="bottom"
        [animationDuration]="0"
        [linear]="true"
        [formGroup]="featureForm"
        (selectionChange)="stepChange($event)"
        *ngIf="!isEditMode"
    >
        <mat-step
            *ngIf="featureForm.get('primaryDetails.feature_id') as featureTypeControl"
            [stepControl]="featureTypeControl"
            [editable]="!(createUpdateObject$ | async)"
        >
            <ng-template matStepLabel>Select Block</ng-template>
            <div class="d-flex flex-column h-100">
                <ng-container
                    *ngTemplateOutlet="
                        selectFeature;
                        context: {
                            featureType: featureType$ | async,
                            featureTypeControl
                        }
                    "
                ></ng-container>
                <div class="d-flex align-items-center justify-content-end">
                    <button type="button" mat-flat-button color="primary" matStepperNext>
                        Next<mat-icon class="material-icons-outlined mat-icon-18 mat-icon-suffix">
                            navigate_next
                        </mat-icon>
                    </button>
                </div>
            </div>
        </mat-step>
        <mat-step
            *ngIf="featureForm.get('primaryDetails.name') as nameControl"
            [stepControl]="nameControl"
            [editable]="!(createUpdateObject$ | async)"
        >
            <ng-template matStepLabel>Block Name</ng-template>
            <div class="d-flex flex-column h-100">
                <ng-container *ngTemplateOutlet="featureName; context: { nameControl }"></ng-container>
                <div class="d-flex align-items-center justify-content-between">
                    <button type="button" mat-flat-button class="flat-default" matStepperPrevious>
                        <mat-icon class="material-icons-outlined mat-icon-18 mat-icon-prefix">navigate_before</mat-icon
                        >Back
                    </button>
                    <button
                        type="button"
                        mat-flat-button
                        color="primary"
                        matStepperNext
                        (click)="nameControl.markAllAsTouched()"
                    >
                        Next
                        <mat-icon class="material-icons-outlined mat-icon-18 mat-icon-suffix">navigate_next</mat-icon>
                    </button>
                </div>
            </div>
        </mat-step>
        <mat-step
            *ngIf="featureForm.get('primaryDetails.feature_id')?.value === 1"
            [completed]="isConfigureMethodValid"
            [editable]="!(createUpdateObject$ | async)"
        >
            <ng-template matStepLabel>Configure Method</ng-template>
            <div class="d-flex flex-column h-100">
                <ng-container *ngTemplateOutlet="configureMethodTemplate"></ng-container>
                <div class="d-flex align-items-center justify-content-between">
                    <button type="button" mat-flat-button class="flat-default" matStepperPrevious>
                        <mat-icon class="material-icons-outlined mat-icon-18 mat-icon-prefix">navigate_before</mat-icon
                        >Back
                    </button>
                    <button
                        type="button"
                        mat-flat-button
                        color="primary"
                        matStepperNext
                        (click)="markDirtyServiceFormTouched()"
                    >
                        Next<mat-icon class="material-icons-outlined mat-icon-18 mat-icon-suffix"
                            >navigate_next</mat-icon
                        >
                    </button>
                </div>
            </div>
        </mat-step>

        <!-- Conditional steps that only show when selected feature_id is not equal to 1 -->
        <ng-container *ngIf="featureForm.get('primaryDetails.feature_id')?.value !== 1">
            <mat-step [editable]="!(createUpdateObject$ | async)">
                <ng-template matStepLabel>Integration Choice</ng-template>
                <div class="d-flex flex-column justify-content-between h-100">
                    <ng-container *ngTemplateOutlet="integrationChoice"></ng-container>
                    <div class="d-flex align-items-center justify-content-between">
                        <button type="button" mat-flat-button class="flat-default" matStepperPrevious>
                            <mat-icon class="material-icons-outlined mat-icon-18 mat-icon-prefix"
                                >navigate_before</mat-icon
                            >Back
                        </button>
                        <button type="button" mat-flat-button color="primary" matStepperNext>
                            Next<mat-icon class="material-icons-outlined mat-icon-18 mat-icon-suffix"
                                >navigate_next</mat-icon
                            >
                        </button>
                    </div>
                </div>
            </mat-step>

            <mat-step [editable]="!(createUpdateObject$ | async)" [completed]="isOrganizationDetailsValid">
                <ng-template matStepLabel>Organization Details</ng-template>
                <div class="d-flex flex-column justify-content-between h-100">
                    <ng-container *ngTemplateOutlet="organizationDetails"></ng-container>
                    <mat-divider class="w-100 mb-4"></mat-divider>

                    <div class="d-flex align-items-center justify-content-between">
                        <button type="button" mat-flat-button class="flat-default" matStepperPrevious>
                            <mat-icon class="material-icons-outlined mat-icon-18 mat-icon-prefix"
                                >navigate_before</mat-icon
                            >Back
                        </button>
                        <button
                            type="button"
                            mat-flat-button
                            color="primary"
                            (click)="markDirtyOrganizationDetailsFormTouched()"
                        >
                            Next<mat-icon class="material-icons-outlined mat-icon-18 mat-icon-suffix"
                                >navigate_next</mat-icon
                            >
                        </button>
                    </div>
                </div>
            </mat-step>

            <mat-step [editable]="!(createUpdateObject$ | async)">
                <ng-template matStepLabel>Billable Metrics / Items</ng-template>
                <div class="d-flex flex-column justify-content-between gap-3 h-100">
                    <ng-container *ngTemplateOutlet="billableMetrics"></ng-container>

                    <div class="d-flex align-items-end justify-content-end">
                        <button
                            type="button"
                            mat-flat-button
                            color="primary"
                            (click)="getPaymentDetailsFormData()"
                            matStepperNext
                        >
                            Next<mat-icon class="material-icons-outlined mat-icon-18 mat-icon-suffix"
                                >navigate_next</mat-icon
                            >
                        </button>
                    </div>
                </div>
            </mat-step>
            <mat-step [editable]="!(createUpdateObject$ | async)">
                <ng-template matStepLabel>Payment Details</ng-template>
                <div class="d-flex flex-column justify-content-between gap-3 h-100">
                    <ng-container *ngTemplateOutlet="paymentDetails"></ng-container>

                    <div class="d-flex align-items-end justify-content-end">
                        <button
                            type="button"
                            mat-flat-button
                            color="primary"
                            (click)="getCreatePlansFormData()"
                            matStepperNext
                        >
                            skip<mat-icon class="material-icons-outlined mat-icon-18 mat-icon-suffix"
                                >navigate_next</mat-icon
                            >
                        </button>
                    </div>
                </div>
            </mat-step>

            <mat-step [editable]="!(createUpdateObject$ | async)" [completed]="isCreatePlansFormControlsValid">
                <ng-template matStepLabel>Create Plan</ng-template>
                <div class="d-flex flex-column h-100">
                    <ng-container *ngTemplateOutlet="createPlan"></ng-container>
                    <div class="d-flex align-items-end justify-content-end">
                        <button type="button" mat-flat-button color="primary" (click)="createPlanAndGenerateSnippet()">
                            Create Plan & Generate Snippet
                        </button>
                    </div>
                </div>
            </mat-step>

            <mat-step [completed]="(createPlan$ | async) && (planData$ | async)">
                <ng-template matStepLabel>Plans Overview & Subscription Snippet</ng-template>
                <div class="d-flex flex-column h-100">
                    <form [formGroup]="featureForm.get('plansOverview')">
                        <ng-container *ngTemplateOutlet="plansOverview"></ng-container>
                    </form>
                    <ng-container *ngTemplateOutlet="designAndCode"></ng-container>
                    <div class="d-flex justify-content-between align-items-center mt-3">
                        <ng-container *ngTemplateOutlet="preview"></ng-container>
                        <button
                            type="button"
                            mat-flat-button
                            color="primary"
                            *ngIf="createUpdateObject$ | async as createUpdateObject"
                            [routerLink]="['/app/features/manage', createUpdateObject?.id]"
                        >
                            Manage Feature<mat-icon class="material-icons-outlined mat-icon-18 mat-icon-suffix"
                                >navigate_next</mat-icon
                            >
                        </button>
                    </div>
                </div>
            </mat-step>
        </ng-container>

        <mat-step
            *ngIf="featureForm.get('primaryDetails.feature_id')?.value === 1"
            [completed]="(createUpdateObject$ | async) && featureForm.get('authorizationDetails')?.valid"
        >
            <ng-template matStepLabel>Authorization Setup</ng-template>
            <div class="d-flex flex-column h-100">
                <ng-container *ngTemplateOutlet="authorizationSetup"></ng-container>
                <div class="d-flex align-items-center justify-content-between">
                    <button type="button" mat-flat-button class="flat-default" matStepperPrevious>
                        <mat-icon class="material-icons-outlined mat-icon-18 mat-icon-prefix">navigate_before</mat-icon
                        >Back
                    </button>
                    <button type="button" mat-flat-button color="primary" (click)="createFeature()">
                        Save & Next<mat-icon class="material-icons-outlined mat-icon-18 mat-icon-suffix"
                            >navigate_next</mat-icon
                        >
                    </button>
                </div>
            </div>
        </mat-step>
        <mat-step *ngIf="featureForm.get('primaryDetails.feature_id')?.value === 1">
            <ng-template matStepLabel>Design & code</ng-template>
            <div class="d-flex flex-column h-100">
                <ng-container *ngTemplateOutlet="designAndCode"></ng-container>
                <div class="d-flex justify-content-between align-items-center mt-3">
                    <ng-container *ngTemplateOutlet="preview"></ng-container>
                    <button
                        type="button"
                        mat-flat-button
                        color="primary"
                        *ngIf="createUpdateObject$ | async as createUpdateObject"
                        [routerLink]="['/app/features/manage', createUpdateObject?.id]"
                    >
                        Manage Feature<mat-icon class="material-icons-outlined mat-icon-18 mat-icon-suffix"
                            >navigate_next</mat-icon
                        >
                    </button>
                </div>
            </div>
        </mat-step>
    </mat-stepper>
    <mat-card class="outline-card p-0 flex-grow-1" *ngIf="isEditMode">
        <mat-tab-group animationDuration="0ms">
            <mat-tab label="Service">
                <div class="d-flex flex-column h-100 p-4">
                    <ng-container *ngIf="featureForm.get('primaryDetails.feature_id')?.value === 1">
                        <ng-container *ngTemplateOutlet="configureMethodTemplate"></ng-container>
                    </ng-container>
                    <ng-container *ngIf="featureForm.get('primaryDetails.feature_id')?.value !== 1">
                        <ng-container *ngTemplateOutlet="manageSubscription"></ng-container>
                    </ng-container>
                    <mat-divider></mat-divider>
                    <div
                        class="d-flex align-items-center justify-content-start mt-3"
                        *ngIf="featureForm.get('primaryDetails.feature_id')?.value === 1"
                    >
                        <button type="button" mat-flat-button color="primary" (click)="updateFeature('service')">
                            Update
                        </button>
                    </div>
                </div>
            </mat-tab>
            <mat-tab label="Setting">
                <div class="d-flex flex-column h-100 p-4">
                    <ng-container *ngTemplateOutlet="authorizationSetup"></ng-container>
                    <mat-divider></mat-divider>
                    <div
                        class="d-flex align-items-center justify-content-start mt-3"
                        *ngIf="featureForm.get('primaryDetails.feature_id')?.value === 1"
                    >
                        <button type="button" mat-flat-button color="primary" (click)="updateFeature('authorization')">
                            Update
                        </button>
                    </div>
                </div>
            </mat-tab>
            <mat-tab label="Design & code">
                <div class="p-3">
                    <ng-container *ngTemplateOutlet="designAndCode"></ng-container>
                    <ng-container *ngTemplateOutlet="preview" class="mt-3"></ng-container>
                </div>
            </mat-tab>
        </mat-tab-group>
    </mat-card>
</div>
<ng-template #selectFeature let-featureType="featureType" let-featureTypeControl="featureTypeControl">
    <div class="flex-grow-1">
        <div class="features-layout">
            <div
                *ngFor="let type of featureType"
                class="border rounded-4 p-3 d-flex flex-column align-items-center justify-content-center feature-card bg-light-grey cursor-pointer"
                (click)="radioInput.click()"
                [ngClass]="{ 'active': type.id === featureTypeControl.value }"
            >
                <mat-icon>{{ type.icon }}</mat-icon>
                <p class="mat-body-2 text-secondary fe-bold">{{ type.name }}</p>
                <input
                    type="radio"
                    name="featureType"
                    hidden
                    #radioInput
                    [formControl]="featureTypeControl"
                    [value]="type.id"
                />
            </div>
        </div>
    </div>
</ng-template>
<ng-template #featureName let-nameControl="nameControl">
    <div class="my-3 flex-grow-1">
        <p class="mat-body-2 text-secondary fw-bold">Give a name of your Block</p>
        <form class="w-50">
            <ng-container
                *ngTemplateOutlet="
                    inputField;
                    context: {
                        fieldControl: nameControl,
                        fieldConfig: {
                            label: 'Name',
                            is_required: true,
                            patternErrorText: 'Name must contain only alphanumeric and underscore'
                        }
                    }
                "
            ></ng-container>
        </form>
    </div>
</ng-template>
<ng-template #configureMethodTemplate let-selectedIndex="selectedIndex">
    <div class="d-flex gap-3 my-3 flex-grow-1" style="min-height: 400px">
        <div class="d-flex flex-column gap-1 border-right pr-3 service-list">
            <p class="mat-body-2 fw-bolder mt-0">Services</p>
            <mat-list role="list" class="default-list pt-0">
                <mat-list-item
                    role="listitem"
                    class="rounded-4"
                    *ngFor="let service of (selectedMethod | async)?.method_services; let i = index"
                    [ngClass]="{ 'active': selectedServiceIndex === i }"
                    (click)="selectedServiceIndex = i"
                >
                    <div class="d-flex align-items-center flex-grow-1">
                        {{ service.name }}
                        <ng-container *ngIf="featureForm.get('serviceDetails')?.at(i) as serviceForm">
                            <mat-icon
                                class="material-icons-outlined mat-icon-18 text-danger ml-1 mt-1"
                                *ngIf="
                                    i !== selectedServiceIndex &&
                                    serviceForm.dirty &&
                                    serviceForm.touched &&
                                    serviceForm.invalid
                                "
                            >
                                error
                            </mat-icon>
                        </ng-container>
                    </div>
                    <mat-icon class="material-icons-outlined mat-icon-18 mt-1">navigate_next</mat-icon>
                </mat-list-item>
            </mat-list>
        </div>
        <div class="auth-credentials px-3" class="width-md-700 w-md-100">
            <div class="d-flex flex-column">
                <ng-container *ngIf="(selectedMethod | async)?.method_services as methodServices">
                    <form
                        [formGroup]="serviceForm"
                        *ngIf="featureForm.get('serviceDetails')?.at(selectedServiceIndex) as serviceForm"
                    >
                        <ng-container *ngIf="methodServices?.[selectedServiceIndex]?.requirements as requirements">
                            <p class="mat-body-2 fw-bolder mt-0">Credentials</p>
                            <ng-container
                                *ngFor="let controlKeyValue of serviceForm.controls.requirements.controls | keyvalue"
                            >
                                <div class="row">
                                    <div class="col-md-12">
                                        <ng-container
                                            *ngTemplateOutlet="
                                                inputField;
                                                context: {
                                                    fieldControl: controlKeyValue.value,
                                                    fieldConfig: requirements[controlKeyValue.key]
                                                }
                                            "
                                        ></ng-container>
                                    </div>
                                </div>
                            </ng-container>
                        </ng-container>
                        <ng-container
                            *ngIf="methodServices?.[selectedServiceIndex]?.configurations?.fields as configurationsFields"
                        >
                            <p class="mat-body-2 fw-bolder mt-0">Configurations</p>
                            <ng-container
                                *ngFor="let controlKeyValue of serviceForm.controls.configurations.controls | keyvalue"
                            >
                                <div class="row">
                                    <div class="col-md-12 w-100">
                                        <ng-container
                                            *ngTemplateOutlet="
                                                inputField;
                                                context: {
                                                    fieldControl: controlKeyValue.value,
                                                    fieldConfig: configurationsFields[controlKeyValue.key]
                                                }
                                            "
                                        ></ng-container>
                                    </div>
                                </div>
                            </ng-container>
                        </ng-container>
                        <mat-form-field
                            appearance="outline"
                            class="w-100"
                            *ngIf="(featureDetails$ | async)?.callback_url as callbackUrl"
                        >
                            <mat-label>Callback URL</mat-label>
                            <input matInput type="text" placeholder="Callback URL" [value]="callbackUrl" disabled />
                            <proxy-copy-button
                                matSuffix
                                [copyData]="callbackUrl"
                                tooltip="Copy URL"
                            ></proxy-copy-button>
                        </mat-form-field>
                        <mat-slide-toggle
                            *ngIf="isEditMode"
                            class="w-100 mat-body-2 mb-4"
                            [formControl]="serviceForm.controls.is_enable"
                        >
                            Enable Service
                        </mat-slide-toggle>
                        <button
                            type="button"
                            mat-flat-button
                            class="flat-default"
                            (click)="resetFormGroup(serviceForm, this.selectedServiceIndex)"
                        >
                            Reset
                        </button>
                    </form>
                </ng-container>
            </div>
        </div>
    </div>
</ng-template>

<ng-template #authorizationSetup>
    <div class="d-flex flex-column gap-3 my-3 flex-grow-1">
        <div class="d-flex flex-column w-50">
            <ng-container
                *ngTemplateOutlet="
                    inputField;
                    context: {
                        fieldControl: featureForm.get('authorizationDetails.session_time'),
                        fieldConfig: {
                            label: 'Session Time',
                            is_required: true,
                            hint: 'Enter session time in seconds',
                            patternErrorText: 'Only integer value allowed'
                        }
                    }
                "
            ></ng-container>
            <ng-container
                *ngTemplateOutlet="
                    inputField;
                    context: {
                        fieldControl: featureForm.get('authorizationDetails.authorizationKey'),
                        fieldConfig: {
                            label: 'Key Name',
                            is_required: true,
                            hint: 'Key name to pass the JWT as e.g &#8221;authorization&#8221;, &#8221;access_token&#8221; etc'
                        }
                    }
                "
            ></ng-container>
        </div>
        <div class="d-flex flex-column w-50">
            <div
                class="overflow-auto code-snippet-view position-relative rounded-4"
                *ngIf="((isEditMode ? featureDetails$ : selectedMethod) | async)?.authorization_format?.format as code"
            >
                <markdown [data]="code | json | language: 'javascript'"> </markdown>
                <proxy-copy-button
                    class="position-absolute"
                    style="top: 16px; right: 8px"
                    [copyData]="code | json"
                    tooltip="Copy JSON"
                    iconClass="text-white"
                ></proxy-copy-button>
            </div>
            <p class="mat-body-2 text-secondary my-2">
                <strong>Note:</strong> JSON format you will receive after login as JWT in Authorization key
            </p>
        </div>
    </div>
</ng-template>

<ng-template #designAndCode>
    <div class="overflow-auto code-snippet-view position-relative rounded-4">
        <markdown [data]="proxyAuthScript | language: 'javascript'"> </markdown>
        <proxy-copy-button
            class="position-absolute"
            style="top: 16px; right: 8px"
            [copyData]="proxyAuthScript"
            tooltip="Copy Script"
            iconClass="text-white"
        ></proxy-copy-button>
    </div>
    <div class="mat-body-2 mt-2">
        <strong>Note: </strong>The social login button will be displayed in a dialog/modal by default.<br />
        To integrate this button into your website or application UI, please add a div with the ID like this -
    </div>
    <div class="overflow-auto code-snippet-view position-relative rounded-4">
        <markdown [data]="demoDiv$ | async | language: 'html'"> </markdown>
        <proxy-copy-button
            class="position-absolute"
            style="top: 16px; right: 8px"
            [copyData]="demoDiv$ | async"
            tooltip="Copy Code"
            iconClass="text-white"
        ></proxy-copy-button>
    </div>
</ng-template>

<ng-template #preview>
    <div
        class="d-flex align-items-center justify-content-start"
        *ngIf="(createUpdateObject$ | async) || (featureDetails$ | async)"
    >
        <button type="button" mat-flat-button color="primary" (click)="previewFeature()">Preview</button>
    </div>
</ng-template>

<ng-template
    #inputField
    let-fieldControl="fieldControl"
    let-fieldConfig="fieldConfig"
    let-isMatchChipField="isMatchChipField"
>
    <mat-form-field
        appearance="outline"
        class="w-100 mb-0"
        [ngSwitch]="fieldConfig?.type"
        [ngClass]="{
            'full-width-chip': isMatchChipField,
            'no-padding': fieldConfig?.type === featureFieldType.ChipList,
            'mat-form-field-invalid':
                fieldConfig?.type === featureFieldType.ChipList && fieldControl?.touched && fieldControl?.errors,
            'full-width': fieldConfig?.type === featureFieldType.TextArea
        }"
    >
        <mat-label
            >{{ fieldConfig?.label }} <span class="text-danger" *ngIf="fieldConfig?.is_required">*</span>
        </mat-label>
        <ng-container *ngSwitchCase="featureFieldType.ChipList">
            <mat-chip-list
                #chipList
                [disabled]="fieldControl.disabled"
                aria-label="{{ fieldConfig?.label }}"
                *ngIf="fieldConfig?.label + '_' + this.selectedServiceIndex as chipListKey"
            >
                <mat-chip
                    *ngFor="let item of chipListValues[chipListKey]"
                    (removed)="updateChipListValues('delete', chipListKey, fieldControl, item)"
                    [removable]="!chipListReadOnlyValues[chipListKey].has(item)"
                    disableRipple
                >
                    {{ item }}
                    <button type="button" matChipRemove *ngIf="!chipListReadOnlyValues[chipListKey].has(item)">
                        <mat-icon>cancel</mat-icon>
                    </button>
                </mat-chip>
                <input
                    matChipInput
                    type="text"
                    [placeholder]="chipListValues[chipListKey].size ? '' : 'Enter ' + fieldConfig?.label"
                    autocomplete="off"
                    [formControl]="fieldControl"
                    [matChipInputFor]="chipList"
                    [matChipInputSeparatorKeyCodes]="chipListSeparatorKeysCodes"
                    (matChipInputTokenEnd)="updateChipListValues('add', chipListKey, fieldControl, $event.value)"
                />
            </mat-chip-list>
        </ng-container>

        <ng-container *ngSwitchCase="featureFieldType.Select">
            <mat-select
                [formControl]="fieldControl"
                [placeholder]="fieldConfig?.placeholder || 'Select ' + fieldConfig?.label"
            >
                <mat-option *ngFor="let option of getSelectOptions(fieldConfig)" [value]="option.value">
                    {{ option.label }}
                </mat-option>
            </mat-select>
        </ng-container>
        <ng-container *ngSwitchCase="featureFieldType.TextArea">
            <textarea
                matInput
                [placeholder]="fieldConfig?.placeholder || 'Enter ' + fieldConfig?.label"
                [formControl]="fieldControl"
                rows="2"
            ></textarea>
        </ng-container>
        <ng-container *ngSwitchCase="featureFieldType.ReadFile">
            <input
                matInput
                type="text"
                placeholder="Choose {{ fieldConfig?.label }} ==>"
                autocomplete="off"
                [formControl]="fieldControl"
                readonly
            />
        </ng-container>
        <ng-container *ngSwitchDefault>
            <input
                matInput
                type="text"
                placeholder="{{ fieldConfig?.placeholder || 'Enter ' + fieldConfig?.label }}"
                autocomplete="off"
                [formControl]="fieldControl"
            />
            <mat-icon
                *ngIf="fieldConfig?.info"
                matSuffix
                [matTooltip]="fieldConfig.info"
                matTooltipPosition="above"
                class="info-icon"
            >
                info
            </mat-icon>
        </ng-container>
        <mat-error *ngIf="fieldControl.touched">
            <ng-container
                *ngTemplateOutlet="
                    matErrors;
                    context: {
                        fieldControl,
                        label: fieldConfig.label,
                        patternErrorText: fieldConfig?.patternErrorText
                    }
                "
            ></ng-container>
        </mat-error>
        <div matSuffix>
            <ng-container
                *ngIf="
                    fieldConfig?.type === featureFieldType.ReadFile &&
                    fieldConfig?.label + '_' + this.selectedServiceIndex as fileKey
                "
            >
                <button
                    color="warn"
                    mat-icon-button
                    *ngIf="fieldControl?.value"
                    (click)="fileInput.files = null; updateFileValue(fileKey, fieldConfig, fieldControl, null)"
                >
                    <mat-icon class="material-icons-outlined mat-icon-18"> close </mat-icon>
                </button>
                <input
                    #fileInput
                    hidden
                    type="file"
                    [accept]="fieldConfig?.allowed_types ?? ''"
                    (change)="updateFileValue(fileKey, fieldConfig, fieldControl, fileInput.files)"
                />
                <button color="primary" mat-icon-button (click)="fileInput.click()">
                    <mat-icon class="material-icons-outlined mat-icon-18"> attach_file </mat-icon>
                </button>
            </ng-container>
        </div>
        <mat-hint *ngIf="fieldConfig?.hint">{{ fieldConfig?.hint }}</mat-hint>
    </mat-form-field>
    <div
        class="mat-form-field-outside-error"
        [ngClass]="{ 'full-width-chip': isMatchChipField }"
        *ngIf="fieldConfig?.type === featureFieldType.ChipList"
    >
        <mat-error *ngIf="fieldControl.touched">
            <ng-container
                *ngTemplateOutlet="
                    matErrors;
                    context: {
                        fieldControl,
                        label: fieldConfig.label,
                        patternErrorText: fieldConfig?.patternErrorText
                    }
                "
            ></ng-container>
        </mat-error>
    </div>
</ng-template>

<ng-template #matErrors let-label="label" let-fieldControl="fieldControl" let-patternErrorText="patternErrorText">
    <mat-error *ngIf="fieldControl?.errors?.customError as customError"> {{ customError }} </mat-error>
    <mat-error *ngIf="fieldControl.errors?.required"> {{ label }} is required. </mat-error>
    <mat-error *ngIf="fieldControl.errors?.minlengthWithSpace"> Min required length is 3 </mat-error>
    <mat-error *ngIf="fieldControl.errors?.noStartEndSpaces"> Start and End spaces are not allowed</mat-error>
    <mat-error *ngIf="fieldControl.errors?.min as minError"> Min value required is {{ minError?.min }} </mat-error>
    <mat-error *ngIf="fieldControl.errors?.max as maxError"> Max value allowed is {{ maxError?.max }} </mat-error>
    <mat-error *ngIf="fieldControl.errors?.minlength as minLengthError">
        Min required length is {{ minLengthError?.requiredLength }}
    </mat-error>
    <mat-error *ngIf="fieldControl.errors?.maxlength as maxLengthError">
        Max allowed length is {{ maxLengthError?.requiredLength }}
    </mat-error>
    <mat-error *ngIf="fieldControl.errors?.pattern">
        {{ patternErrorText ?? 'Enter valid ' + label }}
    </mat-error>
    <mat-error *ngIf="fieldControl?.errors?.atleastOneValueInChipList"> Atleast One Value is Required </mat-error>
</ng-template>

<!-- New template definitions for conditional steps -->
<ng-template #integrationChoice>
    <div class="d-flex flex-column h-100">
        <h5 class="mat-h5 mb-3">Integration Choice</h5>
        <div class="flex-grow-1">
            <div class="features-layout">
                <div
                    *ngFor="let service of (selectedMethod | async)?.method_services; let i = index"
                    class="border rounded-4 p-3 d-flex flex-column align-items-center justify-content-center feature-card bg-light-grey cursor-pointer"
                    (click)="selectedServiceIndex = i"
                    [ngClass]="{ 'active': selectedServiceIndex === i }"
                >
                    <p class="mat-body-2 fe-bold mb-1">{{ service.name }}</p>

                    <!-- Validation/Error Icon -->
                    <ng-container *ngIf="featureForm.get('serviceDetails')?.at(i) as serviceForm">
                        <mat-icon
                            class="material-icons-outlined mat-icon-18 text-danger mt-1"
                            *ngIf="
                                i !== selectedServiceIndex &&
                                serviceForm.dirty &&
                                serviceForm.touched &&
                                serviceForm.invalid
                            "
                        >
                            error
                        </mat-icon>
                    </ng-container>

                    <!-- Hidden radio (for accessibility/consistency if needed) -->
                    <input type="radio" name="serviceChoice" hidden [checked]="selectedServiceIndex === i" />
                </div>
            </div>
        </div>
    </div>
</ng-template>

<ng-template #organizationDetails>
    <div class="d-flex flex-column h-100 w-75">
        <h5 class="mat-h5 mb-3">Organization Details</h5>
        <p class="mat-body-2 text-secondary"><strong>Note:</strong> These details will be shown on the invoice..</p>
        <div class="auth-credentials px-3" class="width-md-700 w-md-100">
            <div class="d-flex flex-column">
                <ng-container *ngIf="(selectedMethod | async)?.method_services as methodServices">
                    <form
                        class="organization-details-form"
                        [formGroup]="serviceForm"
                        *ngIf="featureForm.get('serviceDetails')?.at(selectedServiceIndex) as serviceForm"
                    >
                        <ng-container
                            *ngIf="methodServices?.[selectedServiceIndex]?.configurations?.fields as configurationsFields"
                        >
                            <ng-container
                                *ngFor="
                                    let controlKeyValue of serviceForm.controls.configurations.controls
                                        | keyvalue: keepOrder
                                "
                            >
                                <div class="row">
                                    <div class="col-md-12 w-100">
                                        <ng-container
                                            *ngTemplateOutlet="
                                                inputField;
                                                context: {
                                                    fieldControl: controlKeyValue.value,
                                                    fieldConfig: configurationsFields[controlKeyValue.key]
                                                }
                                            "
                                        ></ng-container>
                                    </div>
                                </div>
                            </ng-container>
                        </ng-container>
                        <mat-form-field
                            appearance="outline"
                            class="w-100"
                            *ngIf="(featureDetails$ | async)?.callback_url as callbackUrl"
                        >
                            <mat-label>Callback URL</mat-label>
                            <input matInput type="text" placeholder="Callback URL" [value]="callbackUrl" disabled />
                            <proxy-copy-button
                                matSuffix
                                [copyData]="callbackUrl"
                                tooltip="Copy URL"
                            ></proxy-copy-button>
                        </mat-form-field>
                        <mat-slide-toggle
                            *ngIf="isEditMode"
                            class="w-100 mat-body-2 mb-4"
                            [formControl]="serviceForm.controls.is_enable"
                        >
                            Enable Service
                        </mat-slide-toggle>
                    </form>
                </ng-container>
            </div>
        </div>
    </div>
</ng-template>

<ng-template #billableMetrics>
    <div class="d-flex flex-column h-100">
        <h5 class="mat-h5 mb-3">Billable Metrics / Items</h5>
        <div>
            <button class="" mat-flat-button color="primary" (click)="addBillableMetric()">
                <mat-icon class="material-icons-outlined mat-icon-18"> add </mat-icon> Add Metric
            </button>
        </div>

        <mat-card class="w-100 outline-card responsive-card flex-grow-1 mt-3 overflow-table overflow-y p-0">
            <mat-card-content>
                <table mat-table [dataSource]="billableMetricstabledata" class="default-table responsive-table">
                    <!-- Name Column -->
                    <ng-container matColumnDef="name">
                        <th mat-header-cell *matHeaderCellDef mat-sort-header class="width-md-300">Name</th>
                        <td mat-cell *matCellDef="let element" data-label="Name">
                            <ng-container>
                                {{ element.name }}
                            </ng-container>
                        </td>
                    </ng-container>

                    <!-- reference_id Column -->
                    <ng-container matColumnDef="code">
                        <th mat-header-cell *matHeaderCellDef mat-sort-header class="width-md-300">Code</th>
                        <td mat-cell *matCellDef="let element" data-label="Reference Id">
                            <ng-container>
                                {{ element.code }}
                                <proxy-copy-button
                                    [copyData]="element.code"
                                    tooltip="Copy Reference Id"
                                ></proxy-copy-button>
                            </ng-container>
                        </td>
                    </ng-container>

                    <!-- Method Column -->
                    <ng-container matColumnDef="type">
                        <th mat-header-cell *matHeaderCellDef mat-sort-header class="width-md-200">Type</th>
                        <td mat-cell *matCellDef="let element" data-label="Type">
                            <ng-container>{{ element.recurring ? 'Recurring' : 'Metered' }}</ng-container>
                        </td>
                    </ng-container>

                    <!-- Type Column -->
                    <ng-container matColumnDef="aggregation">
                        <th mat-header-cell *matHeaderCellDef mat-sort-header class="width-md-200">Aggregation</th>
                        <td mat-cell *matCellDef="let element" data-label="Aggregation">
                            <ng-container>{{ getAggregationLabel(element?.aggregation_type) }}</ng-container>
                        </td>
                    </ng-container>

                    <ng-container matColumnDef="action">
                        <th mat-header-cell *matHeaderCellDef mat-sort-header class="width-md-200">Action</th>
                        <td mat-cell *matCellDef="let element; let i = index" data-label="Action">
                            <button
                                mat-icon-button
                                color="primary"
                                (click)="editMetric(element, i)"
                                matTooltip="Edit Metric"
                            >
                                <mat-icon>edit</mat-icon>
                            </button>
                            <button mat-icon-button color="warn" (click)="deleteMetric(i)" matTooltip="Delete Metric">
                                <mat-icon>delete</mat-icon>
                            </button>
                        </td>
                    </ng-container>

                    <tr mat-header-row *matHeaderRowDef="displayedColumns; sticky: true"></tr>
                    <tr
                        mat-row
                        *matRowDef="let row; columns: displayedColumns; let i = index"
                        class="hover-action"
                    ></tr>

                    <tr class="mat-row" *matNoDataRow>
                        <td class="mat-cell border-none" [attr.colspan]="displayedColumns.length">
                            <div class="text-center w-100 mat-subtitle-2 text-dark">No Record Found</div>
                        </td>
                    </tr>
                </table>
                <mat-paginator-goto></mat-paginator-goto>
            </mat-card-content>
        </mat-card>
    </div>
</ng-template>

<ng-template #paymentDetails>
    <div class="d-flex flex-column h-100">
        <h5 class="mat-h5 mb-3">Payment Details</h5>
        <div class="d-flex flex-column h-100">
            <p class="mat-body-2 text-secondary"><strong>Note:</strong> These details will be shown on the invoice..</p>
            <div class="auth-credentials px-3">
                <div class="d-flex flex-column w-75">
                    <ng-container *ngIf="featureForm.get('paymentDetailsForm')?.at(0) as paymentDetailsForm">
                        <form [formGroup]="paymentDetailsForm">
                            <ng-container
                                *ngFor="let controlKeyValue of paymentDetailsForm.controls.stripe.controls | keyvalue"
                            >
                                <div class="row">
                                    <div class="col-md-12 w-100">
                                        <ng-container
                                            *ngTemplateOutlet="
                                                inputField;
                                                context: {
                                                    fieldControl: controlKeyValue.value,
                                                    fieldConfig: paymentDetailsFormFields[controlKeyValue.key]
                                                }
                                            "
                                        ></ng-container>
                                    </div>
                                </div>
                            </ng-container>
                        </form>
                        <div class="d-flex justify-content-start align-items-center">
                            <button type="button" mat-flat-button color="primary" (click)="savePaymentDetails()">
                                {{ isEditMode ? 'Update' : 'Save' }}
                            </button>
                        </div>
                    </ng-container>
                </div>
            </div>
        </div>
    </div>
</ng-template>

<ng-template #createPlan>
    <div class="d-flex flex-column h-100">
        <h5 class="mat-h5 mb-3">Create Plan</h5>
        <div class="d-flex flex-column h-100">
            <p class="mat-body-2 text-secondary"><strong>Note:</strong> These details will be shown on the invoice..</p>
            <div class="auth-credentials px-3" class="width-md-800 w-md-100">
                <div class="d-flex flex-column">
                    <ng-container *ngIf="(selectedMethod | async)?.method_services as methodServices">
                        <form
                            class="single-form-layout d-flex flex-column gap-1"
                            [formGroup]="serviceForm"
                            *ngIf="featureForm.get('planDetails')?.at(selectedServiceIndex) as serviceForm"
                        >
                            <!-- Plan Details Section -->
                            <div class="form-section d-flex flex-column gap-3">
                                <p class="heading mb-0"><strong>Plan Details</strong></p>
                                <div class="form-grid d-grid gap-3 align-items-start">
                                    <ng-container
                                        *ngFor="
                                            let controlKeyValue of serviceForm.controls.createPlanForm.controls
                                                | keyvalue: keepOrder
                                        "
                                    >
                                        <ng-container
                                            *ngTemplateOutlet="
                                                inputField;
                                                context: {
                                                    fieldControl: controlKeyValue.value,
                                                    fieldConfig: createPlanForm[controlKeyValue.key],
                                                    isMatchChipField:
                                                        createPlanForm[controlKeyValue.key]?.type ===
                                                        featureFieldType.ChipList
                                                }
                                            "
                                        ></ng-container>
                                    </ng-container>
                                </div>
                            </div>

                            <!-- Charges Section -->
                            <mat-card class="charges-card">
                                <mat-card-header>
                                    <mat-card-title class="heading"><strong>Charges</strong></mat-card-title>
                                </mat-card-header>
                                <mat-card-content>
                                    <div class="form-grid d-grid gap-3 align-items-start">
                                        <ng-container
                                            *ngFor="
                                                let controlKeyValue of serviceForm.controls.chargesForm.controls
                                                    | keyvalue: keepOrder
                                            "
                                        >
                                            <ng-container
                                                *ngTemplateOutlet="
                                                    inputField;
                                                    context: {
                                                        fieldControl: controlKeyValue.value,
                                                        fieldConfig: createPlanForm[controlKeyValue.key]
                                                    }
                                                "
                                            ></ng-container>
                                        </ng-container>
                                        <div>
                                            <button mat-flat-button color="primary" (click)="addCharge()">
                                                Add Charge
                                            </button>
                                        </div>
                                    </div>
                                    <!-- Charges Table -->
                                    <div class="charges-table-container" *ngIf="chargesList && chargesList.length > 0">
                                        <table mat-table [dataSource]="chargesList" class="charges-table">
                                            <!-- Metric Column -->
                                            <ng-container matColumnDef="metric">
                                                <th mat-header-cell *matHeaderCellDef>Metric</th>
                                                <td mat-cell *matCellDef="let charge">
                                                    {{
                                                        getBillableMetricName(
                                                            charge.billable_metric_id ||
                                                                charge.lago_billable_metric_code
                                                        ) || 'N/A'
                                                    }}
                                                </td>
                                            </ng-container>

                                            <!-- Model Column -->
                                            <ng-container matColumnDef="model">
                                                <th mat-header-cell *matHeaderCellDef>Model</th>
                                                <td mat-cell *matCellDef="let charge">
                                                    {{ charge.charge_model || 'N/A' }}
                                                </td>
                                            </ng-container>

                                            <!-- Min Amount Column -->
                                            <ng-container matColumnDef="minAmount">
                                                <th mat-header-cell *matHeaderCellDef>Min Amount</th>
                                                <td mat-cell *matCellDef="let charge">
                                                    {{ charge.properties.amount / 100 || '0.00' }}
                                                </td>
                                            </ng-container>

                                            <!-- Actions Column -->
                                            <ng-container matColumnDef="actions">
                                                <th mat-header-cell *matHeaderCellDef>Actions</th>
                                                <td mat-cell *matCellDef="let charge; let i = index">
                                                    <button
                                                        mat-icon-button
                                                        color="warn"
                                                        (click)="removeCharge(i)"
                                                        matTooltip="Remove Charge"
                                                    >
                                                        <mat-icon>delete</mat-icon>
                                                    </button>
                                                </td>
                                            </ng-container>

                                            <tr mat-header-row *matHeaderRowDef="chargesDisplayedColumns"></tr>
                                            <tr mat-row *matRowDef="let row; columns: chargesDisplayedColumns"></tr>
                                        </table>
                                    </div>
                                </mat-card-content>
                            </mat-card>
                        </form>
                    </ng-container>
                </div>
            </div>
        </div>

        <!-- Add your plan creation form here -->
    </div>
</ng-template>

<ng-template #plansOverview>
    <div class="d-flex flex-column">
        <h5 class="mat-h5 mb-3">Created Plans</h5>
        <div>
            <button
                mat-flat-button
                color="primary"
                (click)="addPlan()"
                *ngIf="isEditMode && selectedSubscriptionServiceIndex === -1"
            >
                <mat-icon class="material-icons-outlined mat-icon-18"> add </mat-icon> Add Plan
            </button>
        </div>

        <mat-card class="w-100 outline-card responsive-card flex-grow-1 mt-3 add-plan-edit">
            <mat-card-content>
                <table mat-table [dataSource]="createdPlanData" class="default-table responsive-table">
                    <!-- Name Column -->
                    <ng-container matColumnDef="planName">
                        <th mat-header-cell *matHeaderCellDef mat-sort-header class="width-md-300">Name</th>
                        <td mat-cell *matCellDef="let element" data-label="Name">
                            <ng-container>
                                {{ element.name }}
                            </ng-container>
                        </td>
                    </ng-container>

                    <!-- reference_id Column -->
                    <ng-container matColumnDef="code">
                        <th mat-header-cell *matHeaderCellDef mat-sort-header class="width-md-300">Code</th>
                        <td mat-cell *matCellDef="let element" data-label="Reference Id">
                            <ng-container>
                                {{ element.code }}
                                <proxy-copy-button
                                    [copyData]="element.code"
                                    tooltip="Copy Reference Id"
                                ></proxy-copy-button>
                            </ng-container>
                        </td>
                    </ng-container>

                    <!-- Method Column -->
                    <ng-container matColumnDef="billingPeriod">
                        <th mat-header-cell *matHeaderCellDef mat-sort-header class="width-md-200">Billing Period</th>
                        <td mat-cell *matCellDef="let element" data-label="Type">
                            <ng-container>{{ element.interval }}</ng-container>
                        </td>
                    </ng-container>

                    <!-- Type Column -->
                    <ng-container matColumnDef="price">
                        <th mat-header-cell *matHeaderCellDef mat-sort-header class="width-md-200">Price</th>
                        <td mat-cell *matCellDef="let element" data-label="Aggregation">
                            <ng-container>{{ element.amount_cents / 100 }}</ng-container>
                        </td>
                    </ng-container>

                    <ng-container matColumnDef="currency">
                        <th mat-header-cell *matHeaderCellDef mat-sort-header class="width-md-200">Currency</th>
                        <td mat-cell *matCellDef="let element" data-label="Aggregation">
                            <ng-container>{{ element.amount_currency }}</ng-container>
                        </td>
                    </ng-container>

                    <ng-container matColumnDef="status">
                        <th mat-header-cell *matHeaderCellDef mat-sort-header class="width-md-200">Status</th>
                        <td mat-cell *matCellDef="let element" data-label="Aggregation">
                            <ng-container>{{ getAggregationLabel(element?.aggregation_type) }}</ng-container>
                        </td>
                    </ng-container>

                    <ng-container matColumnDef="action" *ngIf="selectedSubscriptionServiceIndex === -1 && isEditMode">
                        <th mat-header-cell *matHeaderCellDef mat-sort-header class="width-md-200">Action</th>
                        <td mat-cell *matCellDef="let element" data-label="Action">
                            <button type="button" mat-icon-button color="primary" (click)="editPlan(element)">
                                <mat-icon class="material-icons-outlined mat-icon-18"> edit </mat-icon>
                            </button>
                            <button type="button" mat-icon-button color="warn" (click)="deletePlan(element)">
                                <mat-icon class="material-icons-outlined mat-icon-18"> delete </mat-icon>
                            </button>
                        </td>
                    </ng-container>

                    <tr mat-header-row *matHeaderRowDef="plansOverviewColumns; sticky: true"></tr>
                    <tr
                        mat-row
                        *matRowDef="let row; columns: plansOverviewColumns; let i = index"
                        class="hover-action"
                    ></tr>

                    <tr *matNoDataRow>
                        <td class="mat-cell border-none" [attr.colspan]="plansOverviewColumns.length">
                            <proxy-no-record-found [title]="'features'" [showBtn]="false"></proxy-no-record-found>
                        </td>
                    </tr>
                </table>

                <mat-paginator-goto></mat-paginator-goto>
            </mat-card-content>
        </mat-card>
    </div>
</ng-template>
<ng-template #manageSubscription>
    <div class="d-flex gap-3 my-3 flex-grow-1" style="min-height: 400px">
        <div class="d-flex flex-column gap-1 border-right pr-3 service-list">
            <p class="mat-body-2 fw-bolder mt-0">Services</p>
            <mat-list role="list" class="default-list pt-0">
                <!-- Billable Metric item -->
                <mat-list-item
                    role="listitem"
                    class="rounded-4"
                    [ngClass]="{ 'active': selectedSubscriptionServiceIndex === -2 }"
                    (click)="selectedSubscriptionServiceIndex = -2"
                >
                    <div class="d-flex align-items-center flex-grow-1">Billable Metric</div>
                    <mat-icon class="material-icons-outlined mat-icon-18 mt-1">navigate_next</mat-icon>
                </mat-list-item>

                <!-- Plans item -->
                <mat-list-item
                    role="listitem"
                    class="rounded-4"
                    [ngClass]="{ 'active': selectedSubscriptionServiceIndex === -1 }"
                    (click)="selectedSubscriptionServiceIndex = -1"
                >
                    <div class="d-flex align-items-center flex-grow-1">Plans</div>
                    <mat-icon class="material-icons-outlined mat-icon-18 mt-1">navigate_next</mat-icon>
                </mat-list-item>

                <mat-list-item
                    role="listitem"
                    class="rounded-4"
                    [ngClass]="{ 'active': selectedSubscriptionServiceIndex === -3 }"
                    (click)="updatePaymentDetails()"
                >
                    <div class="d-flex align-items-center flex-grow-1">Payment Details</div>
                    <mat-icon class="material-icons-outlined mat-icon-18 mt-1">navigate_next</mat-icon>
                </mat-list-item>
            </mat-list>
        </div>

        <!-- Right panel content -->
        <div class="auth-credentials px-3" class="width-md-700 w-md-100">
            <div class="d-flex flex-column">
                <!-- Plans content -->
                <div *ngIf="selectedSubscriptionServiceIndex === -1">
                    <h3>Plans</h3>
                    <ng-container *ngTemplateOutlet="plansOverview"></ng-container>
                </div>

                <!-- Billable Metric content -->
                <div *ngIf="selectedSubscriptionServiceIndex === -2">
                    <h3>Billable Metric</h3>
                    <ng-container *ngTemplateOutlet="billableMetrics"></ng-container>
                </div>
                <div *ngIf="selectedSubscriptionServiceIndex === -3">
                    <h3>Payment Details</h3>
                    <ng-container *ngTemplateOutlet="paymentDetails"></ng-container>
                </div>
            </div>
        </div>
    </div>
</ng-template>
