<div class="app-content d-flex justify-content-center create-project">
    <mat-stepper #stepper class="w-75 border rounded-8" labelPosition="bottom">
        <mat-step>
            <div class="d-flex flex-column h-100 mt-3">
                <h1 class="fw-bold">Create Project</h1>
                <ng-container *ngTemplateOutlet="createProject"></ng-container>
                <div class="d-flex align-items-center justify-content-end">
                    <button mat-flat-button color="primary" (click)="onNextClick()">
                        Next
                        <mat-icon class="material-icons-outlined mat-icon-18 mat-icon-suffix">navigate_next</mat-icon>
                    </button>
                </div>
            </div>
        </mat-step>

        <mat-step>
            <div class="d-flex flex-column h-100 mt-3">
                <ng-container>
                    <h1 class="fw-bold">Add Gateway URL</h1>
                    <p>
                        The Gateway URL is the entry point through which incoming requests are received and forwarded to
                        the Proxy Server for processing
                    </p>
                </ng-container>

                <ng-container *ngTemplateOutlet="gateWayUrl"></ng-container>
                <div class="d-flex align-items-center justify-content-end">
                    <button type="button" mat-flat-button color="primary" matStepperNext (click)="checkInputfeild()">
                        Next
                        <mat-icon class="material-icons-outlined mat-icon-18 mat-icon-suffix">navigate_next</mat-icon>
                    </button>
                </div>
            </div>
        </mat-step>

        <mat-step>
            <div class="d-flex flex-column h-100 mt-3">
                <ng-container>
                    <h1 class="fw-bold">Add Destination Url</h1>
                    <p class="mat-body-2 text-secondary fw-bold">
                        The destination URL refers to the targeted URL or endpoint where the request will be forwarded
                        by the proxy Server.
                    </p>
                </ng-container>
                <ng-container *ngTemplateOutlet="desnationUrl"></ng-container>
                <div class="d-flex align-items-center justify-content-between">
                    <button type="button" mat-flat-button class="flat-default" matStepperPrevious>
                        <mat-icon class="material-icons-outlined mat-icon-18 mat-icon-prefix">navigate_before</mat-icon
                        >Back
                    </button>
                    <button mat-raised-button color="accent" (click)="submit()">Submit</button>
                </div>
            </div>
        </mat-step>
    </mat-stepper>
</div>

<ng-template #createProject>
    <div class="my-3 flex-grow-1 mt-5">
        <form class="w-50">
            <ng-container
                *ngTemplateOutlet="
                    inputField;
                    context: {
                        fieldControl: primaryDetails.get('name'),
                        fieldConfig: {
                            label: 'Enter Your project name',
                            is_required: true,
                            patternErrorText: 'Name must contain only alphanumeric and underscore'
                        }
                    }
                "
            ></ng-container>
        </form>

        <form class="w-50">
            <mat-form-field appearance="outline" class="no-padding w-xs-100">
                <mat-label>Select Environment</mat-label>
                <proxy-cdk-scroll scrollableElementId="environments">
                    <mat-select multiple [formControl]="primaryDetails.get('selectedEnvironmentsControl')">
                        <mat-select-trigger>
                            {{
                                primaryDetails.get('selectedEnvironmentsControl').value
                                    ? primaryDetails.get('selectedEnvironmentsControl').value.join(', ')
                                    : 'Select Environment'
                            }}
                        </mat-select-trigger>
                        <mat-option
                            *ngFor="let environment of (environments$ | async)?.data"
                            [value]="environment.name"
                            class="mat-body-2"
                        >
                            {{ environment.name }}
                        </mat-option>
                    </mat-select>
                </proxy-cdk-scroll>
            </mat-form-field>
        </form>
        <div class="d-flex rateLimitContainer">
            <form class="rateInput">
                <ng-container
                    *ngTemplateOutlet="
                        inputField;
                        context: {
                            fieldControl: primaryDetails.get('rateLimit_hit'),
                            fieldConfig: {
                                label: 'Hits',
                                type: 'number',
                                patternErrorText: 'Name must contain only alphanumeric and underscore'
                            }
                        }
                    "
                ></ng-container>
            </form>
            <p class="fw-bold mt-5">Hits per</p>
            <form class="rateInput">
                <ng-container
                    *ngTemplateOutlet="
                        inputField;
                        context: {
                            fieldControl: primaryDetails.get('rateLimit_minute'),
                            fieldConfig: {
                                label: 'number',
                                type: 'number',

                                patternErrorText: 'Name must contain only alphanumeric and underscore'
                            }
                        }
                    "
                ></ng-container>
            </form>
            <p class="fw-bold mt-5">minute</p>
        </div>
    </div>
</ng-template>
<ng-template #gateWayUrl>
    <div class="d-flex mt-5 h-75" [formGroup]="gatewayUrlDetails">
        <div class="my-3 w-40">
            <h3>Provide your own</h3>

            <mat-checkbox formControlName="useSameUrlForAll" (change)="onChange($event)"
                >Same for all environments</mat-checkbox
            >

            <ng-container *ngIf="gatewayUrlDetails.get('useSameUrlForAll').value; else multiUrlTemplate">
                <ng-container
                    *ngTemplateOutlet="
                        inputField;
                        context: {
                            fieldControl: gatewayUrlDetails.get('singleUrl'),
                            fieldConfig: {
                                label: 'enter same url for all environment',
                                patternErrorText: 'URL must contain only alphanumeric and underscore'
                            }
                        }
                    "
                ></ng-container>
            </ng-container>

            <ng-template #multiUrlTemplate>
                <ng-container *ngFor="let control of gatewayUrls.controls; let i = index">
                    <h3 class="mb-0">{{ environments_with_slug[i]?.name }}</h3>
                    <ng-container
                        *ngTemplateOutlet="
                            inputField;
                            context: {
                                fieldControl: control,
                                fieldConfig: {
                                    label: environments_with_slug[i]?.name,
                                    patternErrorText: 'URL must contain only alphanumeric and underscore'
                                }
                            }
                        "
                    ></ng-container>
                </ng-container>
            </ng-template>
        </div>

        <div class="p-5 mt-5">
            <h2>OR</h2>
        </div>
        <div class="w-50">
            <h3>Use ours</h3>

            <div *ngFor="let slug of environments_with_slug">
                <h4>{{ slug.name }}</h4>
                <a href="slug.url">{{ slug.url }}</a>
                <proxy-copy-button matSuffix [copyData]="slug.url" tooltip="Copy URL"></proxy-copy-button>
            </div>

            <!-- </div > -->
            <!-- <div *ngFor="let environment of environments_with_slug">
        <h3>{{ environment.name }}</h3>
        <p>URL: <a [href]="environment.url">{{ environment.url }}</a></p>
    </div> -->
            <div class="font-12 mt-3">
                <span class="fw-bolder">Note: </span>
                please copy the provided Gateway URL and utilize it within your user interface to invoke the API by
                specifying the desired endpoint for seamless request forwarding to the Proxy Server
            </div>
        </div>
    </div>
</ng-template>
<ng-template #desnationUrl>
    <div class="my-3 flex-grow-1">
        <form class="w-50" *ngIf="showEndpoint">
            <p class="mat-body-2 text-secondary fw-bold">
                project unique identification In URL
                <span class="info-container" (mouseenter)="showCard = true" (mouseleave)="showCard = false">
                    <mat-icon>info</mat-icon>
                    <card class="info-card bg-primary-light mat-body-2 text-primary" *ngIf="showCard">
                        <mat-card-content>
                            The "project identification in URL" is a key element used by the proxy server to route
                            requests to the approoriate project and environment
                        </mat-card-content>
                    </card>
                </span>
            </p>
            <ng-container
                *ngTemplateOutlet="
                    inputField;
                    context: {
                        fieldControl: destinationUrl.get('endpoint'),
                        fieldConfig: {
                            label: 'endpoint',
                            is_required: true
                        }
                    }
                "
            ></ng-container>
        </form>
        <form class="w-50">
            <div class="d-flex" *ngFor="let control of forwardUrls.controls; let i = index">
                <div>
                    <h4 class="m-0 fw-bold">{{ environments_with_slug[i]?.name }}</h4>
                    <mat-icon>double_arrow</mat-icon>
                    <p class="m-0">forward to</p>
                </div>
                <ng-container
                    class="pt-4"
                    *ngTemplateOutlet="
                        inputField;
                        context: {
                            fieldControl: control,
                            fieldConfig: {
                                label: environments_with_slug[i]?.name,
                                is_required: true
                            }
                        }
                    "
                ></ng-container>
            </div>
        </form>
    </div>
</ng-template>

<ng-template #inputField let-fieldControl="fieldControl" let-fieldConfig="fieldConfig">
    <mat-form-field appearance="outline" class="w-100 pt-4">
        <mat-label
            >{{ fieldConfig?.label }} <span class="text-danger" *ngIf="fieldConfig?.is_required">*</span>
        </mat-label>

        <ng-container>
            <input
                matInput
                [type]="fieldConfig?.type"
                placeholder="Enter {{ fieldConfig?.label }}"
                autocomplete="off"
                [formControl]="fieldControl"
            />
        </ng-container>
        <mat-error *ngIf="fieldControl?.touched">
            <ng-container
                *ngTemplateOutlet="
                    matErrors;
                    context: {
                        fieldControl,
                        label: fieldConfig.label,
                        patternErrorText: fieldConfig?.patternErrorText
                    }
                "
            ></ng-container>
        </mat-error>

        <mat-hint *ngIf="fieldConfig?.hint">{{ fieldConfig?.hint }}</mat-hint>
    </mat-form-field>
</ng-template>

<ng-template #matErrors let-label="label" let-fieldControl="fieldControl" let-patternErrorText="patternErrorText">
    <mat-error *ngIf="fieldControl?.errors?.customError as customError"> {{ customError }} </mat-error>
    <mat-error *ngIf="fieldControl.errors?.required"> {{ label }} is required. </mat-error>
    <mat-error *ngIf="fieldControl.errors?.minlengthWithSpace"> Min required length is 3 </mat-error>
    <mat-error *ngIf="fieldControl.errors?.noStartEndSpaces"> Start and End spaces are not allowed</mat-error>
    <mat-error *ngIf="fieldControl.errors?.min as minError"> Min value required is {{ minError?.min }} </mat-error>
    <mat-error *ngIf="fieldControl.errors?.max as maxError"> Max value allowed is {{ maxError?.max }} </mat-error>
    <mat-error *ngIf="fieldControl.errors?.minlength as minLengthError">
        Min required length is {{ minLengthError?.requiredLength }}
    </mat-error>
    <mat-error *ngIf="fieldControl.errors?.maxlength as maxLengthError">
        Max allowed length is {{ maxLengthError?.requiredLength }}
    </mat-error>
    <mat-error *ngIf="fieldControl.errors?.pattern">
        {{ patternErrorText ?? 'Enter valid ' + label }}
    </mat-error>
</ng-template>
