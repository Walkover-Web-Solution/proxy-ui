<div class="position-relative mat-right-dialog-container">
    <div
        *ngIf="showPage === 'newMethod'"
        class="mat-right-dialog-header d-flex align-items-center justify-content-between"
    >
        <h2 class="mat-subheading-2 mb-0 text-dark">Choose Verfication Method</h2>
        <button mat-icon-button mat-dialog-close color="primary">
            <mat-icon>close</mat-icon>
        </button>
    </div>
    <div class="mat-right-dialog-content">
        <div [formGroup]="defineMethodForm" *ngIf="showPage === 'newMethod'">
            <div class="d-flex align-items-center gap-4">
                <mat-form-field appearance="outline" floatLabel="always" class="w-25">
                    <mat-select placeholder="Select Verfication Method" (selectionChange)="onSelectionChange($event)">
                        <mat-option [value]="method" *ngFor="let method of policyType$ | async; let i = index">{{
                            method.name
                        }}</mat-option>
                    </mat-select>
                </mat-form-field>
                <ng-container
                    *ngTemplateOutlet="
                        inputField;
                        context: {
                            fieldControl: defineMethodForm.get('policyName'),
                            fieldConfig: {
                                label: ' Your Policy name',
                                is_required: true,
                                patternErrorText: 'Name must contain only alphanumeric and underscore'
                            }
                        }
                    "
                >
                </ng-container>
            </div>
            <mat-divider class="mb-3"></mat-divider>
            <form [formGroup]="policy" *ngIf="defineMethodForm.get('policyDetails')?.controls.at(i) as policy">
                <ng-container *ngIf="(selectedPolicy | async)?.configurations?.fields as configurationsFields">
                    <p class="mat-body-2 fw-bold mt-0 mb-3">Configuration</p>
                    <div class="border rounded-8 d-flex flex-wrap p-3 gap-3 align-items-baseline">
                        <ng-container
                            *ngFor="let controlKeyValue of policy.controls.configurations.controls | keyvalue"
                        >
                            <div class="d-flex w-40">
                                <ng-container
                                    *ngTemplateOutlet="
                                        inputField;
                                        context: {
                                            fieldControl: controlKeyValue.value,
                                            fieldConfig: configurationsFields[controlKeyValue.key]
                                        }
                                    "
                                >
                                </ng-container>
                            </div>
                        </ng-container>
                    </div>
                </ng-container>

                <ng-container *ngIf="(selectedPolicy | async)?.requirements as requirements">
                    <p class="mat-body-2 fw-bold mt-0 mb-3 mt-3">requirements</p>
                    <div class="border rounded-8 d-flex flex-wrap p-3 gap-3">
                        <ng-container *ngFor="let controlKeyValue of policy.controls.requirements.controls | keyvalue">
                            <div class="d-flex w-40">
                                <ng-container
                                    *ngTemplateOutlet="
                                        inputField;
                                        context: {
                                            fieldControl: controlKeyValue.value,
                                            fieldConfig: requirements[controlKeyValue.key]
                                        }
                                    "
                                >
                                </ng-container>
                            </div>
                        </ng-container>
                    </div>
                </ng-container>

                <div class="d-flex justify-content-end col-gap-2 mt-4">
                    <button (click)="onsave()" mat-flat-button color="primary">Save</button>
                </div>
            </form>
        </div>
        <ng-container *ngIf="showPage === 'viasocket'">
            <button mat-icon-button mat-dialog-close color="primary">
                <mat-icon>close</mat-icon>
            </button>
            <div class="h-100" id="viasocket-embed-Container"></div>
        </ng-container>

        <ng-container *ngIf="showPage === 'endpointData'">
            <button mat-icon-button mat-dialog-close color="primary">
                <mat-icon>close</mat-icon>
            </button>
            <ng-container
                [ngTemplateOutlet]="jsonCard"
                [ngTemplateOutletContext]="{ title: 'Headers', jsonData: (singleEndpointData$ | async) }"
            >
            </ng-container>
        </ng-container>
    </div>
</div>

<ng-template #inputField let-fieldControl="fieldControl" let-fieldConfig="fieldConfig">
    <mat-form-field appearance="outline" class="w-100 d-flex" [ngSwitch]="fieldConfig?.type">
        <mat-label
            >{{ fieldConfig?.label }} <span class="text-danger" *ngIf="fieldConfig?.is_required">*</span>
        </mat-label>
        <ng-container *ngSwitchCase="policyFieldType.ReadFile">
            <input
                matInput
                type="text"
                placeholder="Choose {{ fieldConfig?.label }} ==>"
                autocomplete="off"
                [formControl]="fieldControl"
                readonly
            />
        </ng-container>
        <ng-container *ngSwitchCase="policyFieldType.Dropdown">
            <ng-container *ngIf="fieldConfig?.type === policyFieldType.Dropdown">
                <mat-select disableRipple [placeholder]="fieldConfig?.name" [formControl]="fieldControl">
                    <mat-option [value]="dropData.value" *ngFor="let dropData of dropdownData[fieldConfig.name]">
                        {{ dropData.label }}
                    </mat-option>
                </mat-select>
            </ng-container>
        </ng-container>
        <div *ngSwitchDefault class="d-flex">
            <input
                matInput
                type="text"
                placeholder="Enter {{ fieldConfig?.label }}"
                autocomplete="off"
                [formControl]="fieldControl"
            />
            <mat-icon
                *ngIf="fieldConfig?.description"
                matSuffix
                class="material-icons-outlined mat-icon-20"
                matTooltip=" {{ fieldConfig?.description }}"
            >
                info
            </mat-icon>
        </div>
        <mat-error *ngIf="fieldControl.touched">
            <ng-container
                *ngTemplateOutlet="
                    matErrors;
                    context: {
                        fieldControl,
                        label: fieldConfig.label,
                        hint: fieldConfig.description,
                        patternErrorText: fieldConfig?.patternErrorText
                    }
                "
            ></ng-container>
        </mat-error>
        <div matSuffix>
            <ng-container
                *ngIf="
                    fieldConfig?.type === policyFieldType.ReadFile &&
                    fieldConfig?.label + '_' + this.selectedServiceIndex as fileKey
                "
            >
                <button
                    color="warn"
                    mat-icon-button
                    *ngIf="fieldControl?.value"
                    (click)="fileInput.files = null; updateFileValue(fileKey, fieldConfig, fieldControl, null)"
                >
                    <mat-icon class="material-icons-outlined mat-icon-18"> close </mat-icon>
                </button>
                <input
                    #fileInput
                    hidden
                    type="file"
                    [accept]="fieldConfig?.allowed_types ?? ''"
                    (change)="updateFileValue(fileKey, fieldConfig, fieldControl, fileInput.files)"
                />
                <button color="primary" mat-icon-button (click)="fileInput.click()">
                    <mat-icon class="material-icons-outlined mat-icon-18"> attach_file </mat-icon>
                </button>
            </ng-container>
        </div>
        <mat-hint *ngIf="fieldConfig?.hint">{{ fieldConfig?.hint }}</mat-hint>
    </mat-form-field>
</ng-template>
<ng-template #matErrors let-label="label" let-fieldControl="fieldControl" let-patternErrorText="patternErrorText">
    <mat-error *ngIf="fieldControl?.errors?.customError as customError"> {{ customError }} </mat-error>
    <mat-error *ngIf="fieldControl.errors?.required"> {{ label }} is required. </mat-error>
    <mat-error *ngIf="fieldControl.errors?.minlengthWithSpace"> Min required length is 3 </mat-error>
    <mat-error *ngIf="fieldControl.errors?.noStartEndSpaces"> Start and End spaces are not allowed</mat-error>
    <mat-error *ngIf="fieldControl.errors?.min as minError"> Min value required is {{ minError?.min }} </mat-error>
    <mat-error *ngIf="fieldControl.errors?.max as maxError"> Max value allowed is {{ maxError?.max }} </mat-error>
    <mat-error *ngIf="fieldControl.errors?.minlength as minLengthError">
        Min required length is {{ minLengthError?.requiredLength }}
    </mat-error>
    <mat-error *ngIf="fieldControl.errors?.maxlength as maxLengthError">
        Max allowed length is {{ maxLengthError?.requiredLength }}
    </mat-error>
    <mat-error *ngIf="fieldControl.errors?.pattern">
        {{ patternErrorText ?? 'Enter valid ' + label }}
    </mat-error>
</ng-template>
<ng-template #jsonCard let-title="title" let-jsonData="jsonData">
    <span class="mb-2 mt-1 mat-body-2 fw-bold"></span>
    <mat-card class="outline-card overflow-y w-break">
        <mat-card-content>
            <pre [innerHtml]="jsonData | json"></pre>
        </mat-card-content>
    </mat-card>
</ng-template>
